<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Off</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- –ß—Ç–æ–±—ã –Ω–∞ —ç–∫—Ä–∞–Ω–µ –î–æ–º–æ–π –≤—ã–≥–ª—è–¥–µ–ª–æ –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Off">

  <style>
    :root {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      color-scheme: dark;
    }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: #000;
      color: #f5f5f5;
    }
    .screen {
      max-width: 430px;
      margin: 0 auto;
      padding: 16px 16px 32px;
    }

    /* –í–µ—Ä—Ö: –∑–∞–≥–æ–ª–æ–≤–æ–∫ + –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–∞ */
    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 8px;
    }
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: #ff9500;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .title-block {
      display: flex;
      flex-direction: column;
    }
    .title {
      font-size: 24px;
      font-weight: 700;
    }
    .subtitle {
      font-size: 14px;
      color: #aaa;
    }
    .badge {
      display: inline-flex;
      margin-top: 6px;
      padding: 3px 10px;
      border-radius: 999px;
      background: #222;
      font-size: 12px;
      color: #ccc;
    }

    .lang-switch {
      display: inline-flex;
      border-radius: 999px;
      background: #151515;
      padding: 2px;
      gap: 2px;
    }
    .lang-btn {
      border: none;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: transparent;
      color: #bbb;
      min-width: 32px;
    }
    .lang-btn.active {
      background: #ff9500;
      color: #000;
      font-weight: 600;
    }

    /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –æ–±—ä–µ–∫—Ça (–î–æ–º / –†–∞–±–æ—Ç–∞) */
    .location-switch {
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
    }
    .location-switch-inner {
      display: inline-flex;
      border-radius: 999px;
      background: #151515;
      padding: 3px;
      gap: 4px;
    }
    .location-btn {
      border: none;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: transparent;
      color: #bbb;
      min-width: 70px;
    }
    .location-btn.active {
      background: #ff9500;
      color: #000;
      font-weight: 600;
    }

    /* –ö–Ω–æ–ø–∫–∏ –¥–Ω–µ–π */
    .days-row {
      display: flex;
      justify-content: space-between;
      margin: 14px 0 4px;
    }
    .day-btn {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: none;
      background: #222;
      color: #ccc;
      font-size: 15px;
    }
    .day-btn.active {
      background: #ff9500;
      color: #fff;
      font-weight: 600;
    }

    .day-mode-label {
      font-size: 11px;
      color: #777;
      margin-bottom: 10px;
    }

    /* –ö–∞—Ä—Ç–æ—á–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è (—Å–ø–∏—Å–æ–∫ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –û–¢–ö–õ–Æ–ß–ï–ù–ò–Ø) */
    .card {
      background: #111;
      border-radius: 18px;
      padding: 8px 0 6px;
      overflow: hidden;
      margin-top: 12px;
    }
    .slot-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
      font-size: 16px;
    }
    .slot-row:nth-child(odd) {
      background: #151515;
    }
    .slot-row.current {
      background: #262626;
    }
    .slot-time {
      color: #ffb84d;
    }
    .slot-duration {
      color: #aaa;
      font-size: 14px;
    }
    .slot-label {
      color: #777;
      font-size: 13px;
    }

    /* –õ–µ–Ω—Ç–∞ "–∫–∞–∫ –≤ –°–≤—ñ—Ç–ª–æ" */
    .timeline {
      margin-top: 10px;
      padding: 10px 12px 8px;
      border-radius: 16px;
      background: #111;
      font-size: 12px;
    }
    .timeline-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .timeline-title {
      font-weight: 600;
      font-size: 13px;
    }
    .timeline-bar {
      display: flex;
      border-radius: 999px;
      overflow: hidden;
      height: 18px;
      background: #222;
    }
    .timeline-segment {
      flex: 1;
      background: #333;  /* –Ω–µ—Ç —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏ */
    }
    .timeline-segment.on {
      background: #ffb84d; /* –µ—Å—Ç—å —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è */
    }
    .timeline-segment.now {
      outline: 2px solid #ffffff;
      outline-offset: -1px;
    }
    .timeline-hours {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      color: #777;
      font-size: 11px;
    }
    .timeline-legend {
      margin-top: 4px;
      color: #888;
      font-size: 11px;
    }

    /* –°—Ç–∞—Ç—É—Å "—Å–µ–π—á–∞—Å" */
    .now-status {
      margin-top: 10px;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      background: #111;
      color: #ccc;
    }
    .now-status span {
      font-weight: 600;
    }

    /* –†–µ–¥–∞–∫—Ç–æ—Ä (—Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã–π) */
    .edit-block {
      margin-top: 18px;
      border-radius: 14px;
      background: #111;
      font-size: 13px;
      overflow: hidden;
    }
    .edit-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      cursor: pointer;
    }
    .edit-header-title {
      font-weight: 600;
    }
    .edit-header-toggle {
      font-size: 14px;
      color: #aaa;
    }
    .edit-body {
      padding: 0 14px 12px;
      display: none; /* –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–æ */
    }
    .edit-note {
      margin-top: 4px;
      font-size: 12px;
      color: #888;
    }
    .edit-title {
      margin-top: 10px;
      font-size: 13px;
    }
    .edit-body textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #333;
      padding: 8px;
      background: #000;
      color: #f5f5f5;
      font-size: 13px;
      font-family: monospace;
      resize: vertical;
      margin-top: 6px;
    }
    .edit-body button {
      margin-top: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      background: #ff9500;
      color: #000;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
    }
    .edit-config {
      margin-top: 10px;
      font-size: 13px;
    }
    .edit-config input {
      margin-left: 6px;
      max-width: 80px;
      padding: 3px 6px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #000;
      color: #f5f5f5;
      font-size: 13px;
    }

    .import-block {
      margin-top: 12px;
      border-top: 1px solid #222;
      padding-top: 8px;
      font-size: 13px;
    }
    .import-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .import-controls {
      margin-bottom: 4px;
    }
    .import-controls select {
      margin-left: 6px;
      padding: 3px 6px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #000;
      color: #f5f5f5;
      font-size: 13px;
    }
    .import-text {
      width: 100%;
      min-height: 70px;
      border-radius: 10px;
      border: 1px solid #333;
      padding: 6px;
      background: #000;
      color: #f5f5f5;
      font-size: 12px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      resize: vertical;
      margin-top: 4px;
    }
    .import-hint {
      margin-top: 4px;
      font-size: 11px;
      color: #888;
    }
  </style>
</head>
<body>
<div class="screen">
  <div class="top-row">
    <div class="header">
      <div class="icon">üí°</div>
      <div class="title-block">
        <div class="title" id="titleHome"></div>
        <div class="subtitle" id="subtitleRegion"></div>
        <div class="badge" id="queueBadge"></div>
      </div>
    </div>
    <div class="lang-switch">
      <button class="lang-btn" data-lang="ru">RU</button>
      <button class="lang-btn" data-lang="uk">UA</button>
    </div>
  </div>

  <div class="location-switch">
    <div class="location-switch-inner">
      <button class="location-btn" data-profile="home"></button>
      <button class="location-btn" data-profile="work"></button>
    </div>
  </div>

  <div class="days-row" id="daysRow"></div>
  <div class="day-mode-label" id="dayModeLabel"></div>

  <div class="timeline" id="timelineBlock">
    <div class="timeline-header-row">
      <div class="timeline-title" id="timelineTitle"></div>
    </div>
    <div class="timeline-bar" id="timelineBar"></div>
    <div class="timeline-hours">
      <span>00</span><span>06</span><span>12</span><span>18</span><span>24</span>
    </div>
    <div class="timeline-legend" id="timelineLegend"></div>
  </div>

  <div class="card" id="slotsContainer"></div>

  <div class="now-status" id="nowStatus"></div>

  <div class="edit-block">
    <div class="edit-header" id="editHeader">
      <div class="edit-header-title" id="editHeaderTitle"></div>
      <div class="edit-header-toggle" id="editHeaderToggle">‚ñ∏</div>
    </div>
    <div class="edit-body" id="editBody">
      <div class="edit-note" id="editNote"></div>

      <div class="edit-title" id="editTitle"></div>
      <textarea id="editArea"></textarea>
      <button id="saveBtn"></button>

      <div class="edit-config">
        <label id="queueLabel">
          –û—á–µ—Ä–µ–¥—å:
          <input id="queueInput" type="text" placeholder="6.2">
        </label>
      </div>

      <div class="import-block">
        <div class="import-title" id="importTitle"></div>
        <div class="import-controls">
          <label id="importQueueLabel">
            –û—á–µ—Ä–µ–¥—å:
            <select id="importQueueSelect">
              <option value="1.1">1.1</option>
              <option value="1.2">1.2</option>
              <option value="2.1">2.1</option>
              <option value="2.2">2.2</option>
              <option value="3.1">3.1</option>
              <option value="3.2">3.2</option>
              <option value="4.1">4.1</option>
              <option value="4.2">4.2</option>
              <option value="5.1">5.1</option>
              <option value="5.2">5.2</option>
              <option value="6.1">6.1</option>
              <option value="6.2">6.2</option>
            </select>
          </label>
        </div>
        <textarea id="importText" class="import-text" placeholder=""></textarea>
        <button id="importBtn"></button>
        <div class="import-hint" id="importHint"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // ----- I18N -----
  const i18n = {
    ru: {
      title_home: '–î–æ–º',
      title_work: '–†–∞–±–æ—Ç–∞',
      region: '–ù–∏–∫–æ–ª–∞–µ–≤—Å–∫–∞—è –æ–±–ª.',
      day_mon: '–ü–Ω',
      day_tue: '–í—Ç',
      day_wed: '–°—Ä',
      day_thu: '–ß—Ç',
      day_fri: '–ü—Ç',
      day_sat: '–°–±',
      day_sun: '–í—Å',
      footer_note: '–§–æ—Ä–º–∞—Ç: HH:MM-HH:MM;HH:MM-HH:MM. –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –≥—Ä–∞—Ñ–∏–∫ –û–¢–ö–õ–Æ–ß–ï–ù–ò–Ø —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è (–±—É–¥–Ω–∏/–≤—ã—Ö–æ–¥–Ω—ã–µ).',
      edit_header: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞',
      edit_title: '–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –æ—Ç–∫–ª—é—á–µ–Ω–∏—è —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏ (—Ä—É—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ):',
      save_btn: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
      slot_label_off: '–Ω–µ—Ç —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏',
      slot_label_on: '–µ—Å—Ç—å —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è',
      now_loading: '–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶',
      now_prefix: '–°–µ–π—á–∞—Å',
      now_off: '–ú–û–ñ–ï–¢ –ù–ï –ë–´–¢–¨ –≠–õ–ï–ö–¢–†–û–≠–ù–ï–†–ì–ò–ò',
      now_ok: '—ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è –µ—Å—Ç—å –ø–æ –≥—Ä–∞—Ñ–∏–∫—É',
      now_time: '–≤—Ä–µ–º—è',
      tl_title: '–°—É—Ç–∫–∏: –∂—ë–ª—Ç—ã–º ‚Äî –∫–æ–≥–¥–∞ –µ—Å—Ç—å —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è',
      tl_legend: '–ñ—ë–ª—Ç—ã–π ‚Äî –µ—Å—Ç—å —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è, —Å–µ—Ä—ã–π ‚Äî –Ω–µ—Ç —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏',
      location_home: '–î–æ–º',
      location_work: '–†–∞–±–æ—Ç–∞',
      day_mode_prefix: '–†–µ–∂–∏–º: ',
      weekday_label: '–±—É–¥–Ω–∏',
      weekend_label: '–≤—ã—Ö–æ–¥–Ω—ã–µ',
      import_title: '–ò–º–ø–æ—Ä—Ç –≥—Ä–∞—Ñ–∏–∫–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞',
      import_hint: '–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–ª–Ω—ã–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º, –≤—ã–±–µ—Ä–∏—Ç–µ –æ—á–µ—Ä–µ–¥—å –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å¬ª. –ë—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º (–±—É–¥–Ω–∏/–≤—ã—Ö–æ–¥–Ω—ã–µ) –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞.',
      import_button: '–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å',
      import_error: '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤—ã–±—Ä–∞–Ω–Ω—É—é –æ—á–µ—Ä–µ–¥—å –≤ —Ç–µ–∫—Å—Ç–µ.',
      queue_label: '–û—á–µ—Ä–µ–¥—å',
    },
    uk: {
      title_home: '–î—ñ–º',
      title_work: '–†–æ–±–æ—Ç–∞',
      region: '–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞ –æ–±–ª.',
      day_mon: '–ü–Ω',
      day_tue: '–í—Ç',
      day_wed: '–°—Ä',
      day_thu: '–ß—Ç',
      day_fri: '–ü—Ç',
      day_sat: '–°–±',
      day_sun: '–ù–¥',
      footer_note: '–§–æ—Ä–º–∞—Ç: HH:MM-HH:MM;HH:MM-HH:MM. –†–µ–¥–∞–≥—É—î—Ç—å—Å—è –≥—Ä–∞—Ñ—ñ–∫ –í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—ó –¥–ª—è –æ–±—Ä–∞–Ω–æ–≥–æ –¥–Ω—è (–±—É–¥–Ω—ñ/–≤–∏—Ö—ñ–¥–Ω—ñ).',
      edit_header: '–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫–∞',
      edit_title: '–Ü–Ω—Ç–µ—Ä–≤–∞–ª–∏ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—ó (—Ä—É—á–Ω–µ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è):',
      save_btn: '–ó–±–µ—Ä–µ–≥—Ç–∏',
      slot_label_off: '–Ω–µ–º–∞—î –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—ó',
      slot_label_on: '—î –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—è',
      now_loading: '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶',
      now_prefix: '–ó–∞—Ä–∞–∑',
      now_off: '–ú–û–ñ–ï –ù–ï –ë–£–¢–ò –ï–õ–ï–ö–¢–†–û–ï–ù–ï–†–ì–Ü–á',
      now_ok: '–µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—è —î –∑–∞ –≥—Ä–∞—Ñ—ñ–∫–æ–º',
      now_time: '—á–∞—Å',
      tl_title: '–î–æ–±–∞: –∂–æ–≤—Ç–∏–º ‚Äî –∫–æ–ª–∏ —î –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—è',
      tl_legend: '–ñ–æ–≤—Ç–∏–π ‚Äî —î –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—è, —Å—ñ—Ä–∏–π ‚Äî –Ω–µ–º–∞—î –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—ó',
      location_home: '–î—ñ–º',
      location_work: '–†–æ–±–æ—Ç–∞',
      day_mode_prefix: '–†–µ–∂–∏–º: ',
      weekday_label: '–±—É–¥–Ω—ñ',
      weekend_label: '–≤–∏—Ö—ñ–¥–Ω—ñ',
      import_title: '–Ü–º–ø–æ—Ä—Ç –≥—Ä–∞—Ñ—ñ–∫–∞ –∑ —Ç–µ–∫—Å—Ç—É',
      import_hint: '–í—Å—Ç–∞–≤—Ç–µ —Å—é–¥–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –ø–æ–≤–Ω–∏–º —Ä–æ–∑–∫–ª–∞–¥–æ–º, –æ–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏¬ª. –ë—É–¥–µ –æ–Ω–æ–≤–ª–µ–Ω–æ –ø–æ—Ç–æ—á–Ω–∏–π —Ä–µ–∂–∏–º (–±—É–¥–Ω—ñ/–≤–∏—Ö—ñ–¥–Ω—ñ) –¥–ª—è –æ–±—Ä–∞–Ω–æ–≥–æ –æ–±‚Äô—î–∫—Ç–∞.',
      import_button: '–Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏',
      import_error: '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –æ–±—Ä–∞–Ω—É —á–µ—Ä–≥—É –≤ —Ç–µ–∫—Å—Ç—ñ.',
      queue_label: '–ß–µ—Ä–≥–∞',
    }
  };

  const PROFILES = ['home', 'work'];
  const PROFILE_KEY_PREFIX = 'offlight_profile_';
  const PROFILE_CURRENT_KEY = 'offlight_profile_current';
  const LANG_KEY = 'offlight_lang';
  const EDIT_OPEN_KEY = 'offlight_edit_open';

  const days = [
    {key: 'mon', labelKey: 'day_mon'},
    {key: 'tue', labelKey: 'day_tue'},
    {key: 'wed', labelKey: 'day_wed'},
    {key: 'thu', labelKey: 'day_thu'},
    {key: 'fri', labelKey: 'day_fri'},
    {key: 'sat', labelKey: 'day_sat'},
    {key: 'sun', labelKey: 'day_sun'},
  ];

  const defaultDaySlots = [
    ['00:00', '01:00'],
    ['08:00', '15:00'],
    ['18:30', '22:00'],
  ];

  let currentLang = localStorage.getItem(LANG_KEY) || 'ru';
  let profiles = {};
  let currentProfile = localStorage.getItem(PROFILE_CURRENT_KEY) || 'home';
  if (!PROFILES.includes(currentProfile)) currentProfile = 'home';

  function t(key) {
    return (i18n[currentLang] && i18n[currentLang][key])
      || (i18n['ru'] && i18n['ru'][key])
      || key;
  }

  function getTodayKey() {
    const jsDay = new Date().getDay();
    switch (jsDay) {
      case 0: return 'sun';
      case 1: return 'mon';
      case 2: return 'tue';
      case 3: return 'wed';
      case 4: return 'thu';
      case 5: return 'fri';
      case 6: return 'sat';
    }
  }

  function isWeekendDay(dayKey) {
    return dayKey === 'sat' || dayKey === 'sun';
  }

  function defaultProfileData() {
    return {
      weekday: defaultDaySlots.slice(),
      weekend: defaultDaySlots.slice(),
      queueCode: '6.2',
    };
  }

  function loadProfile(profile) {
    const raw = localStorage.getItem(PROFILE_KEY_PREFIX + profile);
    if (!raw) return defaultProfileData();
    try {
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed.weekday)) parsed.weekday = defaultDaySlots.slice();
      if (!Array.isArray(parsed.weekend)) parsed.weekend = defaultDaySlots.slice();
      if (!parsed.queueCode) parsed.queueCode = '6.2';
      return parsed;
    } catch (e) {
      return defaultProfileData();
    }
  }

  function saveProfile(profile) {
    localStorage.setItem(PROFILE_KEY_PREFIX + profile, JSON.stringify(profiles[profile]));
  }

  PROFILES.forEach(p => {
    profiles[p] = loadProfile(p);
  });

  let currentDayKey = getTodayKey();
  let editOpen = localStorage.getItem(EDIT_OPEN_KEY) || '0';

  // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
  const titleHomeEl = document.getElementById('titleHome');
  const subtitleRegionEl = document.getElementById('subtitleRegion');
  const queueBadgeEl = document.getElementById('queueBadge');
  const daysRow = document.getElementById('daysRow');
  const dayModeLabelEl = document.getElementById('dayModeLabel');
  const slotsContainer = document.getElementById('slotsContainer');
  const nowStatus = document.getElementById('nowStatus');
  const timelineBar = document.getElementById('timelineBar');
  const timelineTitle = document.getElementById('timelineTitle');
  const timelineLegend = document.getElementById('timelineLegend');

  const editHeader = document.getElementById('editHeader');
  const editHeaderTitle = document.getElementById('editHeaderTitle');
  const editHeaderToggle = document.getElementById('editHeaderToggle');
  const editBody = document.getElementById('editBody');
  const editNoteEl = document.getElementById('editNote');
  const editTitleEl = document.getElementById('editTitle');
  const editArea = document.getElementById('editArea');
  const saveBtn = document.getElementById('saveBtn');
  const queueInput = document.getElementById('queueInput');

  const importTitleEl = document.getElementById('importTitle');
  const importQueueSelect = document.getElementById('importQueueSelect');
  const importText = document.getElementById('importText');
  const importBtn = document.getElementById('importBtn');
  const importHintEl = document.getElementById('importHint');
  const queueLabelEl = document.getElementById('queueLabel');
  const importQueueLabelEl = document.getElementById('importQueueLabel');

  const langButtons = document.querySelectorAll('.lang-btn');
  const locationButtons = document.querySelectorAll('.location-btn');

  function parseTimeToMinutes(t) {
    const [h, m] = t.split(':').map(Number);
    return h * 60 + m;
  }

  function minutesToTime(m) {
    m = (m + 1440) % 1440;
    const h = Math.floor(m / 60);
    const mm = m % 60;
    const hhStr = String(h).padStart(2, '0');
    const mmStr = String(mm).padStart(2, '0');
    return `${hhStr}:${mmStr}`;
  }

  function formatDuration(start, end) {
    let s = parseTimeToMinutes(start);
    let e = parseTimeToMinutes(end);
    if (e <= s) e += 24 * 60;
    const mins = e - s;
    const hours = Math.floor(mins / 60);
    const rest = mins % 60;
    if (currentLang === 'ru') {
      let res = '';
      if (hours > 0) res += hours + '—á';
      if (rest > 0) res += (res ? ' ' : '') + rest + '–º–∏–Ω';
      if (!res) res = '0–º–∏–Ω';
      return res;
    } else {
      let res = '';
      if (hours > 0) res += hours + '–≥';
      if (rest > 0) res += (res ? ' ' : '') + rest + '—Ö–≤';
      if (!res) res = '0—Ö–≤';
      return res;
    }
  }

  function isNowInSlot(start, end) {
    const now = new Date();
    const minutesNow = now.getHours() * 60 + now.getMinutes();
    let s = parseTimeToMinutes(start);
    let e = parseTimeToMinutes(end);
    if (e <= s) e += 24 * 60;
    return minutesNow >= s && minutesNow <= e;
  }

  function getProfileSlots(profileKey, dayKey) {
    const profile = profiles[profileKey];
    const group = isWeekendDay(dayKey) ? 'weekend' : 'weekday';
    return profile[group] || [];
  }

  // –õ–µ–Ω—Ç–∞ "–∫–∞–∫ –≤ –°–≤—ñ—Ç–ª–æ" ‚Äî 24 —Å–µ–≥–º–µ–Ω—Ç–∞ –ø–æ —á–∞—Å–∞–º
  function renderTimeline() {
    const offSlots = getProfileSlots(currentProfile, currentDayKey);
    const minutesOff = new Array(1440).fill(false);

    offSlots.forEach(([start, end]) => {
      let s = parseTimeToMinutes(start);
      let e = parseTimeToMinutes(end);
      if (e <= s) {
        for (let m = s; m < 1440; m++) minutesOff[m] = true;
        for (let m = 0; m < e; m++) minutesOff[m] = true;
      } else {
        for (let m = s; m < e; m++) minutesOff[m] = true;
      }
    });

    const now = new Date();
    const nowHour = now.getHours();

    timelineBar.innerHTML = '';
    for (let h = 0; h < 24; h++) {
      const center = h * 60 + 30;
      const off = minutesOff[center];
      const seg = document.createElement('div');
      seg.className = 'timeline-segment' + (off ? '' : ' on');
      if (h === nowHour) {
        seg.className += ' now';
      }
      timelineBar.appendChild(seg);
    }

    timelineTitle.textContent = t('tl_title');
    timelineLegend.textContent = t('tl_legend');
  }

  function renderLangTexts() {
    const titleKey = currentProfile === 'home' ? 'title_home' : 'title_work';
    titleHomeEl.textContent = t(titleKey);
    subtitleRegionEl.textContent = t('region');

    const queueCode = profiles[currentProfile].queueCode || '6.2';
    const queuePrefix = currentLang === 'ru' ? t('queue_label') : t('queue_label');
    queueBadgeEl.textContent = queuePrefix + ' ' + queueCode;

    langButtons.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.lang === currentLang);
    });

    locationButtons.forEach(btn => {
      const p = btn.dataset.profile;
      const txtKey = p === 'home' ? 'location_home' : 'location_work';
      btn.textContent = t(txtKey);
      btn.classList.toggle('active', p === currentProfile);
    });

    document.querySelectorAll('.day-btn').forEach(btn => {
      const key = btn.dataset.dayKey;
      const d = days.find(x => x.key === key);
      btn.textContent = t(d.labelKey);
    });

    editHeaderTitle.textContent = t('edit_header');
    editNoteEl.textContent = t('footer_note');
    editTitleEl.textContent = t('edit_title');
    saveBtn.textContent = t('save_btn');
    queueLabelEl.childNodes[0].nodeValue = t('queue_label') + ': ';
    importTitleEl.textContent = t('import_title');
    importQueueLabelEl.childNodes[0].nodeValue = t('queue_label') + ': ';
    importBtn.textContent = t('import_button');
    importHintEl.textContent = t('import_hint');

    timelineTitle.textContent = t('tl_title');
    timelineLegend.textContent = t('tl_legend');
  }

  function renderDays() {
    document.querySelectorAll('.day-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.dayKey === currentDayKey);
    });
  }

  function renderDayModeLabel() {
    const weekend = isWeekendDay(currentDayKey);
    const labelKey = weekend ? 'weekend_label' : 'weekday_label';
    dayModeLabelEl.textContent = t('day_mode_prefix') + t(labelKey);
  }

  function renderSlots() {
    const offSlots = getProfileSlots(currentProfile, currentDayKey);
    slotsContainer.innerHTML = '';

    offSlots.forEach(([start, end]) => {
      const row = document.createElement('div');
      const current = isNowInSlot(start, end);
      row.className = 'slot-row' + (current ? ' current' : '');

      const left = document.createElement('div');
      left.innerHTML = `<div class="slot-time">${start} ‚Äì ${end}</div>`;

      const right = document.createElement('div');
      right.innerHTML = `<div class="slot-duration">${formatDuration(start, end)}</div>
                         <div class="slot-label">${t('slot_label_off')}</div>`;

      row.appendChild(left);
      row.appendChild(right);
      slotsContainer.appendChild(row);
    });

    // –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
    editArea.value = offSlots.map(s => s.join('-')).join(';');
  }

  function renderNowStatus() {
    const now = new Date();
    const todayKey = getTodayKey();
    const slotsToday = getProfileSlots(currentProfile, todayKey);
    let inSlot = false;
    let currentSlot = null;
    for (const [start, end] of slotsToday) {
      if (isNowInSlot(start, end)) {
        inSlot = true;
        currentSlot = [start, end];
        break;
      }
    }
    const timeStr = now.toTimeString().slice(0, 5);
    if (inSlot && currentSlot) {
      nowStatus.innerHTML =
        `${t('now_prefix')} <span>${t('now_off')}</span> (${currentSlot[0]}‚Äì${currentSlot[1]}), ${t('now_time')} ${timeStr}`;
    } else {
      nowStatus.innerHTML =
        `${t('now_prefix')} <span>${t('now_ok')}</span>, ${t('now_time')} ${timeStr}`;
    }
  }

  function renderAll() {
    renderLangTexts();
    renderDays();
    renderDayModeLabel();
    renderSlots();
    renderTimeline();
    renderNowStatus();
    // –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª–µ –æ—á–µ—Ä–µ–¥–∏ –ø–æ–¥ —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å
    queueInput.value = profiles[currentProfile].queueCode || '6.2';
    updateEditHeader();
  }

  // --- –†–µ–¥–∞–∫—Ç–æ—Ä: —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ ---
  function applyEditCollapse() {
    editBody.style.display = (editOpen === '1') ? 'block' : 'none';
  }

  function updateEditHeader() {
    editHeaderToggle.textContent = (editOpen === '1') ? '‚ñæ' : '‚ñ∏';
  }

  editHeader.addEventListener('click', () => {
    editOpen = (editOpen === '1') ? '0' : '1';
    localStorage.setItem(EDIT_OPEN_KEY, editOpen);
    applyEditCollapse();
    updateEditHeader();
  });

  // --- –ò–º–ø–æ—Ä—Ç: –ø–∞—Ä—Å–∏–Ω–≥ —Ç–µ–∫—Å—Ç–∞ ---
  function extractQueueLine(text, queueCode) {
    const pattern = new RegExp('^\\s*' + queueCode.replace('.', '\\.') + '\\s*[‚Äì-]\\s*(.+)$', 'm');
    const match = text.match(pattern);
    if (!match) return null;
    return match[1].trim();
  }

  function parseIntervalsFromString(intervalsStr) {
    const parts = intervalsStr.split(';');
    const slots = [];
    for (const p of parts) {
      const trimmed = p.trim();
      if (!trimmed) continue;
      const pieces = trimmed.split(/\s*[-‚Äì‚Äî]\s*/);
      if (pieces.length < 2) continue;
      let start = pieces[0].trim();
      let end = pieces[1].trim();
      start = start.replace(/[^\d:]/g, '');
      end = end.replace(/[^\d:]/g, '');
      if (!start || !end) continue;
      // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–æ HH:MM (–µ—Å–ª–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, "8:0")
      const toHHMM = v => {
        const [hRaw, mRaw] = v.split(':');
        let h = parseInt(hRaw, 10);
        let m = parseInt(mRaw || '0', 10);
        if (isNaN(h)) h = 0;
        if (isNaN(m)) m = 0;
        const hh = String(Math.max(0, Math.min(23, h))).padStart(2, '0');
        const mm = String(Math.max(0, Math.min(59, m))).padStart(2, '0');
        return hh + ':' + mm;
      };
      start = toHHMM(start);
      end = toHHMM(end);
      slots.push([start, end]);
    }
    return slots;
  }

  // --- –ö–Ω–æ–ø–∫–∏ –¥–Ω–µ–π ---
  days.forEach(d => {
    const btn = document.createElement('button');
    btn.className = 'day-btn';
    btn.dataset.dayKey = d.key;
    btn.addEventListener('click', () => {
      currentDayKey = d.key;
      renderAll();
    });
    daysRow.appendChild(btn);
  });

  // --- –°–º–µ–Ω–∞ —è–∑—ã–∫–∞ ---
  langButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const lang = btn.dataset.lang;
      if (lang === currentLang) return;
      currentLang = lang;
      localStorage.setItem(LANG_KEY, lang);
      renderAll();
    });
  });

  // --- –°–º–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–∞ (–î–æ–º / –†–∞–±–æ—Ç–∞) ---
  locationButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const p = btn.dataset.profile;
      if (p === currentProfile) return;
      currentProfile = p;
      localStorage.setItem(PROFILE_CURRENT_KEY, currentProfile);
      renderAll();
    });
  });

  // --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ (—Ä—É—á–Ω–æ–µ) ---
  saveBtn.addEventListener('click', () => {
    const text = editArea.value.trim();
    const parts = text ? text.split(';') : [];
    const slots = [];
    for (const p of parts) {
      const trimmed = p.trim();
      if (!trimmed) continue;
      const pieces = trimmed.split(/\s*[-‚Äì‚Äî]\s*/);
      if (pieces.length < 2) continue;
      let start = pieces[0].trim();
      let end = pieces[1].trim();
      start = start.replace(/[^\d:]/g, '');
      end = end.replace(/[^\d:]/g, '');
      if (!start || !end) continue;
      const toHHMM = v => {
        const [hRaw, mRaw] = v.split(':');
        let h = parseInt(hRaw, 10);
        let m = parseInt(mRaw || '0', 10);
        if (isNaN(h)) h = 0;
        if (isNaN(m)) m = 0;
        const hh = String(Math.max(0, Math.min(23, h))).padStart(2, '0');
        const mm = String(Math.max(0, Math.min(59, m))).padStart(2, '0');
        return hh + ':' + mm;
      };
      start = toHHMM(start);
      end = toHHMM(end);
      slots.push([start, end]);
    }
    const group = isWeekendDay(currentDayKey) ? 'weekend' : 'weekday';
    profiles[currentProfile][group] = slots;
    saveProfile(currentProfile);
    renderAll();
  });

  // --- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ –≤—Ä—É—á–Ω—É—é ---
  queueInput.addEventListener('change', () => {
    const val = queueInput.value.trim();
    if (val) {
      profiles[currentProfile].queueCode = val;
      saveProfile(currentProfile);
      renderAll();
    }
  });

  // --- –ò–º–ø–æ—Ä—Ç –∏–∑ —Ç–µ–∫—Å—Ç–∞ ---
  importBtn.addEventListener('click', () => {
    const queueCode = importQueueSelect.value.trim() || profiles[currentProfile].queueCode || '6.2';
    const txt = importText.value.trim();
    if (!txt) return;

    const line = extractQueueLine(txt, queueCode);
    if (!line) {
      importHintEl.textContent = t('import_error');
      return;
    }
    const slots = parseIntervalsFromString(line);
    if (!slots.length) {
      importHintEl.textContent = t('import_error');
      return;
    }

    const group = isWeekendDay(currentDayKey) ? 'weekend' : 'weekday';
    profiles[currentProfile][group] = slots;
    profiles[currentProfile].queueCode = queueCode;
    saveProfile(currentProfile);

    importHintEl.textContent = t('import_hint');
    importText.value = '';
    renderAll();
  });

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  applyEditCollapse();
  renderAll();

  setInterval(() => {
    renderNowStatus();
    renderTimeline();
  }, 60000);
</script>
</body>
</html>
