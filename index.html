<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Off</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Off">

  <style>
    :root {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      color-scheme: dark;
    }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: #000;
      color: #f5f5f5;
    }
    .screen {
      max-width: 430px;
      margin: 0 auto;
      padding: 16px 16px 32px;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 8px;
    }
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: #ff9500;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .title-block {
      display: flex;
      flex-direction: column;
    }
    .title {
      font-size: 24px;
      font-weight: 700;
    }
    .subtitle {
      font-size: 14px;
      color: #aaa;
    }
    .badge {
      display: inline-flex;
      margin-top: 6px;
      padding: 3px 10px;
      border-radius: 999px;
      background: #222;
      font-size: 12px;
      color: #ccc;
    }

    .lang-switch {
      display: inline-flex;
      border-radius: 999px;
      background: #151515;
      padding: 2px;
      gap: 2px;
    }
    .lang-btn {
      border: none;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: transparent;
      color: #bbb;
      min-width: 32px;
    }
    .lang-btn.active {
      background: #ff9500;
      color: #000;
      font-weight: 600;
    }

    .location-switch {
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
    }
    .location-switch-inner {
      display: inline-flex;
      border-radius: 999px;
      background: #151515;
      padding: 3px;
      gap: 4px;
    }
    .location-btn {
      border: none;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: transparent;
      color: #bbb;
      min-width: 70px;
    }
    .location-btn.active {
      background: #ff9500;
      color: #000;
      font-weight: 600;
    }

    .days-row {
      display: flex;
      justify-content: space-between;
      margin: 14px 0 8px;
    }
    .day-btn {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: none;
      background: #222;
      color: #ccc;
      font-size: 15px;
    }
    .day-btn.active {
      background: #ff9500;
      color: #fff;
      font-weight: 600;
    }

    /* –®–∫–∞–ª–∞ –Ω–∞ —Å—É—Ç–∫–∏ */
    .timeline {
      margin-top: 4px;
      padding: 10px 12px 8px;
      border-radius: 16px;
      background: #111;
      font-size: 12px;
    }
    .timeline-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .timeline-title {
      font-weight: 600;
      font-size: 13px;
    }
    .timeline-bar {
      display: flex;
      border-radius: 999px;
      overflow: hidden;
      height: 18px;
      background: #222;
    }
    .timeline-segment {
      flex: 1;
      background: #333;  /* –Ω–µ—Ç —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏ */
    }
    .timeline-segment.on {
      background: #ffb84d; /* –µ—Å—Ç—å —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è */
    }
    .timeline-segment.now {
      outline: 2px solid #ffffff;
      outline-offset: -1px;
    }
    .timeline-hours {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      color: #777;
      font-size: 11px;
    }
    .timeline-legend {
      margin-top: 4px;
      color: #888;
      font-size: 11px;
    }

    /* –°–ø–∏—Å–æ–∫ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (–∫–∞–∫ –≤ –°–≤—ñ—Ç–ª–æ) */
    .graph-card {
      margin-top: 10px;
      background: #111;
      border-radius: 18px;
      overflow: hidden;
    }
    .graph-row {
      display: flex;
      align-items: center;
      padding: 8px 16px;
      font-size: 16px;
    }
    .graph-row:nth-child(odd) {
      background: #151515;
    }
    .graph-row.current {
      background: #262626;
    }
    .graph-icon {
      width: 20px;
      margin-right: 8px;
      font-size: 14px;
      text-align: center;
      color: #777;
    }
    .graph-time {
      flex: 1;
      font-weight: 500;
    }
    .graph-time.on {
      color: #ffb84d;
    }
    .graph-time.off {
      color: #888;
    }
    .graph-duration {
      font-size: 14px;
      color: #aaa;
      margin-left: 8px;
      white-space: nowrap;
    }

    .off-list {
      margin-top: 8px;
      padding: 6px 10px;
      border-radius: 12px;
      background: #111;
      font-size: 12px;
      color: #ccc;
    }
    .off-list span.label {
      font-weight: 600;
      margin-right: 4px;
    }

    .edit-block {
      margin-top: 16px;
      border-radius: 14px;
      background: #111;
      font-size: 13px;
      overflow: hidden;
    }
    .edit-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      cursor: pointer;
    }
    .edit-header-title {
      font-weight: 600;
    }
    .edit-header-toggle {
      font-size: 14px;
      color: #aaa;
    }
    .edit-body {
      padding: 0 14px 12px;
      display: none;
    }
    .edit-note {
      margin-top: 4px;
      font-size: 12px;
      color: #888;
    }
    .edit-title {
      margin-top: 10px;
      font-size: 13px;
    }
    .edit-body textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #333;
      padding: 8px;
      background: #000;
      color: #f5f5f5;
      font-size: 13px;
      font-family: monospace;
      resize: vertical;
      margin-top: 6px;
    }
    .edit-body button {
      margin-top: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      background: #ff9500;
      color: #000;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
    }
    .edit-config {
      margin-top: 10px;
      font-size: 13px;
    }
    .edit-config label {
      display: block;
      margin-bottom: 4px;
    }
    .edit-config input {
      margin-left: 6px;
      max-width: 140px;
      padding: 3px 6px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #000;
      color: #f5f5f5;
      font-size: 13px;
    }

    .import-block {
      margin-top: 12px;
      border-top: 1px solid #222;
      padding-top: 8px;
      font-size: 13px;
    }
    .import-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .import-controls {
      margin-bottom: 4px;
    }
    .import-controls select {
      margin-left: 6px;
      padding: 3px 6px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #000;
      color: #f5f5f5;
      font-size: 13px;
    }
    .import-text {
      width: 100%;
      min-height: 70px;
      border-radius: 10px;
      border: 1px solid #333;
      padding: 6px;
      background: #000;
      color: #f5f5f5;
      font-size: 12px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      resize: vertical;
      margin-top: 4px;
    }
    .import-hint {
      margin-top: 4px;
      font-size: 11px;
      color: #888;
    }
  </style>
</head>
<body>
<div class="screen">
  <div class="top-row">
    <div class="header">
      <div class="icon">üí°</div>
      <div class="title-block">
        <div class="title" id="titlePlace"></div>
        <div class="subtitle" id="subtitleRegion"></div>
        <div class="badge" id="queueBadge"></div>
      </div>
    </div>
    <div class="lang-switch">
      <button class="lang-btn" data-lang="ru">RU</button>
      <button class="lang-btn" data-lang="uk">UA</button>
    </div>
  </div>

  <div class="location-switch">
    <div class="location-switch-inner">
      <button class="location-btn" data-profile="home"></button>
      <button class="location-btn" data-profile="work"></button>
    </div>
  </div>

  <div class="days-row" id="daysRow"></div>

  <div class="timeline" id="timelineBlock">
    <div class="timeline-header-row">
      <div class="timeline-title" id="timelineTitle"></div>
    </div>
    <div class="timeline-bar" id="timelineBar"></div>
    <div class="timeline-hours">
      <span>00</span><span>06</span><span>12</span><span>18</span><span>24</span>
    </div>
    <div class="timeline-legend" id="timelineLegend"></div>
  </div>

  <div class="graph-card" id="graphCard"></div>

  <div class="off-list" id="offList"></div>

  <div class="edit-block">
    <div class="edit-header" id="editHeader">
      <div class="edit-header-title" id="editHeaderTitle"></div>
      <div class="edit-header-toggle" id="editHeaderToggle">‚ñ∏</div>
    </div>
    <div class="edit-body" id="editBody">
      <div class="edit-note" id="editNote"></div>

      <div class="edit-title" id="editTitle"></div>
      <textarea id="editArea"></textarea>
      <button id="saveBtn"></button>

      <div class="edit-config">
        <label id="placeNameLabel">
          –ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞:
          <input id="placeNameInput" type="text" placeholder="–î–æ–º">
        </label>
        <label id="queueLabel">
          –û—á–µ—Ä–µ–¥—å:
          <input id="queueInput" type="text" placeholder="6.2">
        </label>
      </div>

      <div class="import-block">
        <div class="import-title" id="importTitle"></div>
        <div class="import-controls">
          <label id="importQueueLabel">
            –û—á–µ—Ä–µ–¥—å:
            <select id="importQueueSelect">
              <option value="1.1">1.1</option>
              <option value="1.2">1.2</option>
              <option value="2.1">2.1</option>
              <option value="2.2">2.2</option>
              <option value="3.1">3.1</option>
              <option value="3.2">3.2</option>
              <option value="4.1">4.1</option>
              <option value="4.2">4.2</option>
              <option value="5.1">5.1</option>
              <option value="5.2">5.2</option>
              <option value="6.1">6.1</option>
              <option value="6.2">6.2</option>
            </select>
          </label>
        </div>
        <textarea id="importText" class="import-text"></textarea>
        <button id="importBtn"></button>
        <div class="import-hint" id="importHint"></div>
      </div>
    </div>
  </div>
</div>

<script>
  const i18n = {
    ru: {
      place_home_default: '–î–æ–º',
      place_work_default: '–†–∞–±–æ—Ç–∞',
      region: '–ù–∏–∫–æ–ª–∞–µ–≤—Å–∫–∞—è –æ–±–ª.',
      day_mon: '–ü–Ω',
      day_tue: '–í—Ç',
      day_wed: '–°—Ä',
      day_thu: '–ß—Ç',
      day_fri: '–ü—Ç',
      day_sat: '–°–±',
      day_sun: '–í—Å',
      location_home: '–î–æ–º',
      location_work: '–†–∞–±–æ—Ç–∞',
      off_list_label: '–û—Ç–∫–ª—é—á–µ–Ω–∏—è:',
      edit_header: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞',
      edit_note: '–§–æ—Ä–º–∞—Ç: HH:MM-HH:MM;HH:MM-HH:MM. –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –≥—Ä–∞—Ñ–∏–∫ –û–¢–ö–õ–Æ–ß–ï–ù–ò–Ø —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è.',
      edit_title: '–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –æ—Ç–∫–ª—é—á–µ–Ω–∏—è —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏ (—Ä—É—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ):',
      save_btn: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
      place_name_label: '–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞',
      queue_label: '–û—á–µ—Ä–µ–¥—å',
      import_title: '–ò–º–ø–æ—Ä—Ç –≥—Ä–∞—Ñ–∏–∫–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞',
      import_hint: '–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–ª–Ω—ã–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º, –≤—ã–±–µ—Ä–∏—Ç–µ –æ—á–µ—Ä–µ–¥—å –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å¬ª.',
      import_button: '–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å',
      import_error: '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤—ã–±—Ä–∞–Ω–Ω—É—é –æ—á–µ—Ä–µ–¥—å –≤ —Ç–µ–∫—Å—Ç–µ.',
      import_queue_label: '–û—á–µ—Ä–µ–¥—å',
      tl_title: '–°—É—Ç–∫–∏: –∂—ë–ª—Ç—ã–º ‚Äî –∫–æ–≥–¥–∞ –µ—Å—Ç—å —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è',
      tl_legend: '–ñ—ë–ª—Ç—ã–π ‚Äî –µ—Å—Ç—å —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è, —Å–µ—Ä—ã–π ‚Äî –Ω–µ—Ç —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏',
    },
    uk: {
      place_home_default: '–î—ñ–º',
      place_work_default: '–†–æ–±–æ—Ç–∞',
      region: '–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞ –æ–±–ª.',
      day_mon: '–ü–Ω',
      day_tue: '–í—Ç',
      day_wed: '–°—Ä',
      day_thu: '–ß—Ç',
      day_fri: '–ü—Ç',
      day_sat: '–°–±',
      day_sun: '–ù–¥',
      location_home: '–î—ñ–º',
      location_work: '–†–æ–±–æ—Ç–∞',
      off_list_label: '–í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è:',
      edit_header: '–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫–∞',
      edit_note: '–§–æ—Ä–º–∞—Ç: HH:MM-HH:MM;HH:MM-HH:MM. –†–µ–¥–∞–≥—É—î—Ç—å—Å—è –≥—Ä–∞—Ñ—ñ–∫ –í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—ó –¥–ª—è –æ–±—Ä–∞–Ω–æ–≥–æ –¥–Ω—è.',
      edit_title: '–Ü–Ω—Ç–µ—Ä–≤–∞–ª–∏ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—ó (—Ä—É—á–Ω–µ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è):',
      save_btn: '–ó–±–µ—Ä–µ–≥—Ç–∏',
      place_name_label: '–ù–∞–∑–≤–∞ –º—ñ—Å—Ü—è',
      queue_label: '–ß–µ—Ä–≥–∞',
      import_title: '–Ü–º–ø–æ—Ä—Ç –≥—Ä–∞—Ñ—ñ–∫–∞ –∑ —Ç–µ–∫—Å—Ç—É',
      import_hint: '–í—Å—Ç–∞–≤—Ç–µ —Å—é–¥–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –ø–æ–≤–Ω–∏–º —Ä–æ–∑–∫–ª–∞–¥–æ–º, –æ–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏¬ª.',
      import_button: '–Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏',
      import_error: '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –æ–±—Ä–∞–Ω—É —á–µ—Ä–≥—É –≤ —Ç–µ–∫—Å—Ç—ñ.',
      import_queue_label: '–ß–µ—Ä–≥–∞',
      tl_title: '–î–æ–±–∞: –∂–æ–≤—Ç–∏–º ‚Äî –∫–æ–ª–∏ —î –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—è',
      tl_legend: '–ñ–æ–≤—Ç–∏–π ‚Äî —î –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—è, —Å—ñ—Ä–∏–π ‚Äî –Ω–µ–º–∞—î –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—ó',
    }
  };

  const PROFILES = ['home', 'work'];
  const PROFILE_KEY_PREFIX = 'off_profile_';
  const PROFILE_CURRENT_KEY = 'off_profile_current';
  const LANG_KEY = 'off_lang';
  const EDIT_OPEN_KEY = 'off_edit_open';

  const days = [
    {key: 'mon', labelKey: 'day_mon'},
    {key: 'tue', labelKey: 'day_tue'},
    {key: 'wed', labelKey: 'day_wed'},
    {key: 'thu', labelKey: 'day_thu'},
    {key: 'fri', labelKey: 'day_fri'},
    {key: 'sat', labelKey: 'day_sat'},
    {key: 'sun', labelKey: 'day_sun'},
  ];

  const defaultDaySlots = [
    ['00:00','01:00'],
    ['08:00','15:00'],
    ['18:30','22:00'],
  ];

  let currentLang = localStorage.getItem(LANG_KEY) || 'ru';
  let profiles = {};
  let currentProfile = localStorage.getItem(PROFILE_CURRENT_KEY) || 'home';
  if (!PROFILES.includes(currentProfile)) currentProfile = 'home';

  function t(key){
    return (i18n[currentLang] && i18n[currentLang][key]) ||
           (i18n['ru'] && i18n['ru'][key]) || key;
  }

  function defaultProfileData(profileKey){
    return {
      name: profileKey === 'home' ? t('place_home_default') : t('place_work_default'),
      queueCode: '6.2',
      days: {
        mon: defaultDaySlots.slice(),
        tue: defaultDaySlots.slice(),
        wed: defaultDaySlots.slice(),
        thu: defaultDaySlots.slice(),
        fri: defaultDaySlots.slice(),
        sat: defaultDaySlots.slice(),
        sun: defaultDaySlots.slice(),
      }
    };
  }

  function loadProfile(profileKey){
    const raw = localStorage.getItem(PROFILE_KEY_PREFIX + profileKey);
    if(!raw) return defaultProfileData(profileKey);
    try{
      const parsed = JSON.parse(raw);
      if(!parsed.name) parsed.name = defaultProfileData(profileKey).name;
      if(!parsed.queueCode) parsed.queueCode = '6.2';
      if(!parsed.days) parsed.days = {};
      days.forEach(d=>{
        if(!Array.isArray(parsed.days[d.key])) parsed.days[d.key]=defaultDaySlots.slice();
      });
      return parsed;
    }catch(e){
      return defaultProfileData(profileKey);
    }
  }

  function saveProfile(profileKey){
    localStorage.setItem(PROFILE_KEY_PREFIX + profileKey, JSON.stringify(profiles[profileKey]));
  }

  PROFILES.forEach(p => profiles[p]=loadProfile(p));

  function getTodayKey(){
    const jsDay = new Date().getDay();
    switch(jsDay){
      case 0: return 'sun';
      case 1: return 'mon';
      case 2: return 'tue';
      case 3: return 'wed';
      case 4: return 'thu';
      case 5: return 'fri';
      case 6: return 'sat';
    }
  }

  let currentDayKey = getTodayKey();
  let editOpen = localStorage.getItem(EDIT_OPEN_KEY) || '0';

  const titlePlaceEl = document.getElementById('titlePlace');
  const subtitleRegionEl = document.getElementById('subtitleRegion');
  const queueBadgeEl = document.getElementById('queueBadge');
  const daysRow = document.getElementById('daysRow');
  const graphCard = document.getElementById('graphCard');
  const offListEl = document.getElementById('offList');

  const timelineBar = document.getElementById('timelineBar');
  const timelineTitle = document.getElementById('timelineTitle');
  const timelineLegend = document.getElementById('timelineLegend');

  const editHeader = document.getElementById('editHeader');
  const editHeaderTitle = document.getElementById('editHeaderTitle');
  const editHeaderToggle = document.getElementById('editHeaderToggle');
  const editBody = document.getElementById('editBody');
  const editNoteEl = document.getElementById('editNote');
  const editTitleEl = document.getElementById('editTitle');
  const editArea = document.getElementById('editArea');
  const saveBtn = document.getElementById('saveBtn');
  const placeNameInput = document.getElementById('placeNameInput');
  const queueInput = document.getElementById('queueInput');
  const placeNameLabel = document.getElementById('placeNameLabel');
  const queueLabel = document.getElementById('queueLabel');

  const importTitleEl = document.getElementById('importTitle');
  const importQueueLabel = document.getElementById('importQueueLabel');
  const importQueueSelect = document.getElementById('importQueueSelect');
  const importText = document.getElementById('importText');
  const importBtn = document.getElementById('importBtn');
  const importHintEl = document.getElementById('importHint');

  const langButtons = document.querySelectorAll('.lang-btn');
  const locationButtons = document.querySelectorAll('.location-btn');

  function parseTimeToMinutes(t){
    const [h,m]=t.split(':').map(Number);
    return h*60+(m||0);
  }
  function minutesToTime(m){
    m=(m+1440)%1440;
    const h=Math.floor(m/60), mm=m%60;
    return String(h).padStart(2,'0')+':'+String(mm).padStart(2,'0');
  }
  function formatDuration(start,end){
    let s=parseTimeToMinutes(start), e=parseTimeToMinutes(end);
    if(e<=s)e+=1440;
    const mins=e-s, h=Math.floor(mins/60), r=mins%60;
    if(currentLang==='ru'){
      let res='';
      if(h>0)res+=h+'—á';
      if(r>0)res+=(res?' ':'')+r+'–º–∏–Ω';
      if(!res)res='0–º–∏–Ω';
      return res;
    }else{
      let res='';
      if(h>0)res+=h+'–≥';
      if(r>0)res+=(res?' ':'')+r+'—Ö–≤';
      if(!res)res='0—Ö–≤';
      return res;
    }
  }

  function getDaySlots(profileKey, dayKey){
    return profiles[profileKey].days[dayKey] || [];
  }

  // —Å—Ç—Ä–æ–∏–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å on/off —Å–µ–≥–º–µ–Ω—Ç–æ–≤ 0‚Äì24
  function buildSegments(offSlots){
    const minutesOff=new Array(1440).fill(false);
    offSlots.forEach(([start,end])=>{
      let s=parseTimeToMinutes(start), e=parseTimeToMinutes(end);
      if(e<=s){
        for(let m=s;m<1440;m++)minutesOff[m]=true;
        for(let m=0;m<e;m++)minutesOff[m]=true;
      }else{
        for(let m=s;m<e;m++)minutesOff[m]=true;
      }
    });
    const segments=[];
    let currentState=minutesOff[0];
    let start=0;
    for(let m=1;m<=1440;m++){
      const state=m<1440?minutesOff[m]:null;
      if(state!==currentState){
        segments.push({startMin:start,endMin:m,type:currentState?'off':'on'});
        start=m;
        currentState=state;
      }
    }
    return segments.map(seg=>{
      const startTime=minutesToTime(seg.startMin);
      const endTime=minutesToTime(seg.endMin%1440);
      return {start:startTime,end:endTime,type:seg.type,startMin:seg.startMin,endMin:seg.endMin};
    });
  }

  function renderLangTexts(){
    subtitleRegionEl.textContent=t('region');

    langButtons.forEach(btn=>{
      btn.classList.toggle('active',btn.dataset.lang===currentLang);
    });

    locationButtons.forEach(btn=>{
      const p=btn.dataset.profile;
      const key=p==='home'?'location_home':'location_work';
      btn.textContent=t(key);
      btn.classList.toggle('active',p===currentProfile);
    });

    document.querySelectorAll('.day-btn').forEach(btn=>{
      const key=btn.dataset.dayKey;
      const d=days.find(x=>x.key===key);
      btn.textContent=t(d.labelKey);
    });

    editHeaderTitle.textContent=t('edit_header');
    editNoteEl.textContent=t('edit_note');
    editTitleEl.textContent=t('edit_title');
    saveBtn.textContent=t('save_btn');
    placeNameLabel.childNodes[0].nodeValue=t('place_name_label')+': ';
    queueLabel.childNodes[0].nodeValue=t('queue_label')+': ';
    importTitleEl.textContent=t('import_title');
    importQueueLabel.childNodes[0].nodeValue=t('import_queue_label')+': ';
    importBtn.textContent=t('import_button');
    importHintEl.textContent=t('import_hint');
    timelineTitle.textContent=t('tl_title');
    timelineLegend.textContent=t('tl_legend');
  }

  function renderHeader(){
    const profile=profiles[currentProfile];
    titlePlaceEl.textContent=profile.name || (currentProfile==='home'?t('place_home_default'):t('place_work_default'));
    subtitleRegionEl.textContent=t('region');
    queueBadgeEl.textContent=t('queue_label')+' '+(profile.queueCode || '6.2');
  }

  function renderDays(){
    document.querySelectorAll('.day-btn').forEach(btn=>{
      btn.classList.toggle('active',btn.dataset.dayKey===currentDayKey);
    });
  }

  function renderTimeline(){
    const offSlots=getDaySlots(currentProfile,currentDayKey);
    const minutesOff=new Array(1440).fill(false);
    offSlots.forEach(([start,end])=>{
      let s=parseTimeToMinutes(start), e=parseTimeToMinutes(end);
      if(e<=s){
        for(let m=s;m<1440;m++)minutesOff[m]=true;
        for(let m=0;m<e;m++)minutesOff[m]=true;
      }else{
        for(let m=s;m<e;m++)minutesOff[m]=true;
      }
    });

    const now=new Date();
    const nowHour=now.getHours();

    timelineBar.innerHTML='';
    for(let h=0;h<24;h++){
      const center=h*60+30;
      const off=minutesOff[center];
      const seg=document.createElement('div');
      seg.className='timeline-segment'+(off?'':' on');
      if(h===nowHour) seg.className+=' now';
      timelineBar.appendChild(seg);
    }
  }

  function renderGraph(){
    const offSlots=getDaySlots(currentProfile,currentDayKey);
    const segments=buildSegments(offSlots);

    graphCard.innerHTML='';
    const now=new Date();
    const nowMinutes=now.getHours()*60+now.getMinutes();

    segments.forEach(seg=>{
      const row=document.createElement('div');
      row.className='graph-row';

      let s=seg.startMin, e=seg.endMin;
      if(e<=s)e+=1440;
      const center=(s+e)/2;
      let nowAdj=nowMinutes;
      if(nowAdj< s) nowAdj+=1440;
      if(nowAdj>=s && nowAdj<=e) row.classList.add('current');

      const iconDiv=document.createElement('div');
      iconDiv.className='graph-icon';
      iconDiv.textContent = seg.type==='off' ? '‚úñ' : '';

      const timeDiv=document.createElement('div');
      timeDiv.className='graph-time '+(seg.type==='off'?'off':'on');
      timeDiv.textContent=`${seg.start} ‚Äì ${seg.end}`;

      const durDiv=document.createElement('div');
      durDiv.className='graph-duration';
      durDiv.textContent=formatDuration(seg.start,seg.end);

      row.appendChild(iconDiv);
      row.appendChild(timeDiv);
      row.appendChild(durDiv);
      graphCard.appendChild(row);
    });

    const label=t('off_list_label');
    if(offSlots.length){
      const listStr=offSlots.map(s=>`${s[0]}‚Äì${s[1]}`).join('; ');
      offListEl.innerHTML=`<span class="label">${label}</span>${listStr}`;
    }else{
      offListEl.innerHTML=`<span class="label">${label}</span>‚Äî`;
    }
  }

  function renderEditorFields(){
    const profile=profiles[currentProfile];
    placeNameInput.value=profile.name || '';
    queueInput.value=profile.queueCode || '6.2';
    const offSlots=getDaySlots(currentProfile,currentDayKey);
    editArea.value=offSlots.map(s=>s.join('-')).join(';');
  }

  function applyEditCollapse(){
    editBody.style.display=(editOpen==='1')?'block':'none';
    editHeaderToggle.textContent=(editOpen==='1')?'‚ñæ':'‚ñ∏';
  }

  function renderAll(){
    renderLangTexts();
    renderHeader();
    renderDays();
    renderTimeline();
    renderGraph();
    renderEditorFields();
    applyEditCollapse();
  }

  days.forEach(d=>{
    const btn=document.createElement('button');
    btn.className='day-btn';
    btn.dataset.dayKey=d.key;
    btn.addEventListener('click',()=>{
      currentDayKey=d.key;
      renderAll();
    });
    daysRow.appendChild(btn);
  });

  langButtons.forEach(btn=>{
    btn.addEventListener('click',()=>{
      const lang=btn.dataset.lang;
      if(lang===currentLang)return;
      currentLang=lang;
      localStorage.setItem(LANG_KEY,lang);
      renderAll();
    });
  });

  locationButtons.forEach(btn=>{
    btn.addEventListener('click',()=>{
      const p=btn.dataset.profile;
      if(p===currentProfile)return;
      currentProfile=p;
      localStorage.setItem(PROFILE_CURRENT_KEY,p);
      renderAll();
    });
  });

  editHeader.addEventListener('click',()=>{
    editOpen = (editOpen==='1')?'0':'1';
    localStorage.setItem(EDIT_OPEN_KEY,editOpen);
    applyEditCollapse();
  });

  saveBtn.addEventListener('click',()=>{
    const text=editArea.value.trim();
    const parts=text?text.split(';'):[];
    const slots=[];
    const normalize=(v)=>{
      const [hRaw,mRaw]=v.split(':');
      let h=parseInt(hRaw,10), m=parseInt(mRaw||'0',10);
      if(isNaN(h))h=0; if(isNaN(m))m=0;
      return String(Math.max(0,Math.min(23,h))).padStart(2,'0')+':' +
             String(Math.max(0,Math.min(59,m))).padStart(2,'0');
    };
    for(const p of parts){
      const trimmed=p.trim();
      if(!trimmed)continue;
      const pieces=trimmed.split(/\s*[-‚Äì‚Äî]\s*/);
      if(pieces.length<2)continue;
      let start=normalize(pieces[0].trim());
      let end=normalize(pieces[1].trim());
      slots.push([start,end]);
    }
    profiles[currentProfile].days[currentDayKey]=slots;
    saveProfile(currentProfile);
    renderTimeline();
    renderGraph();
    renderEditorFields();
  });

  placeNameInput.addEventListener('change',()=>{
    const val=placeNameInput.value.trim();
    if(!val)return;
    profiles[currentProfile].name=val;
    saveProfile(currentProfile);
    renderHeader();
  });

  queueInput.addEventListener('change',()=>{
    const val=queueInput.value.trim();
    if(!val)return;
    profiles[currentProfile].queueCode=val;
    saveProfile(currentProfile);
    renderHeader();
  });

  function extractQueueLine(text,queueCode){
    const pattern=new RegExp('^\\s*'+queueCode.replace('.','\\.')+'\\s*[‚Äì-]\\s*(.+)$','m');
    const match=text.match(pattern);
    if(!match)return null;
    return match[1].trim();
  }

  function parseIntervalsFromString(intervalsStr){
    const parts=intervalsStr.split(';');
    const slots=[];
    const normalize=(v)=>{
      const [hRaw,mRaw]=v.split(':');
      let h=parseInt(hRaw,10), m=parseInt(mRaw||'0',10);
      if(isNaN(h))h=0; if(isNaN(m))m=0;
      return String(Math.max(0,Math.min(23,h))).padStart(2,'0')+':' +
             String(Math.max(0,Math.min(59,m))).padStart(2,'0');
    };
    for(const p of parts){
      const trimmed=p.trim();
      if(!trimmed)continue;
      const pieces=trimmed.split(/\s*[-‚Äì‚Äî]\s*/);
      if(pieces.length<2)continue;
      let start=normalize(pieces[0].trim());
      let end=normalize(pieces[1].trim());
      slots.push([start,end]);
    }
    return slots;
  }

  importBtn.addEventListener('click',()=>{
    const queueCode=(importQueueSelect.value || profiles[currentProfile].queueCode || '6.2').trim();
    const txt=importText.value.trim();
    if(!txt)return;
    const line=extractQueueLine(txt,queueCode);
    if(!line){
      importHintEl.textContent=t('import_error');
      return;
    }
    const slots=parseIntervalsFromString(line);
    if(!slots.length){
      importHintEl.textContent=t('import_error');
      return;
    }
    profiles[currentProfile].days[currentDayKey]=slots;
    profiles[currentProfile].queueCode=queueCode;
    saveProfile(currentProfile);
    importText.value='';
    importHintEl.textContent=t('import_hint');
    renderAll();
  });

  renderAll();
  setInterval(()=>{renderTimeline();},60000);
</script>
</body>
</html>
